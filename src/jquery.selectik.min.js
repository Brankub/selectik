// Copyright (c) 2012 Ivan Kubrakov 
// Selectik: a jQuery custom select plugin http://brankub.github.com/selectik/

(function(a){var f=!1,p=!1;a.selectik=function(E,M){var l,w,k,m,F,G,x,y,H,q=!1,z=!1,d,i,h,r,s,g,A,B,t,N={containerClass:"custom-select",width:0,maxItems:0,customScroll:1,speedAnimation:200},j=this;j.settings={};var c=a(E);j.init=function(){d=a.extend({},N,M);0==d.width&&(c.wrap("<span/>"),d.width=c.parent().width(),c.parent().replaceWith(c));c.wrap('<div class="'+d.containerClass+'"></div>');g=c.parent();I({refreshSelect:!1});var b=a('input[type="reset"]',c.parents("form"));0<b.length&&b.bind("click", function(){var b=0<t.length?t.index():0;C(a("option:eq("+b+")",c))});c.bind("change",function(){if(z)return z=!1;C(a("option:selected",a(this)))});r.bind("click",function(){if(g.hasClass("disable"))return!1;c.focus();D(i,!1,!0)});c.bind("focus",function(){g.addClass("active")});c.bind("blur",function(){g.removeClass("active");f&&(j.hideCS(),c.parent().removeClass("active"))});c.bind("keyup",function(b){13==b.keyCode&&i.is(":visible")&&D(i,!0,!1);a.browser.msie||27==b.keyCode&&i.is(":visible")&&D(i, !0,!0);c.change();q&&J(a("option:selected",c).index())});a.browser.opera&&c.bind("keydown",function(){p=!0})};var I=function(b){var n="";l=E.length;b.refreshSelect&&a("ul",g).remove();B=a("option",c);for(var e=0;e<B.length;e++){var f=a(B[e]);F="disabled"===f.attr("disabled")?"disabled":"";n+='<li class="'+F+'" data-value="'+f[0].value+'">'+f[0].text+"</li>"}e=0<d.maxItems&&1==d.customScroll?'<div class="select-scroll"><span class="scroll-drag"><\!-- --\></span></div>':"";f=1==d.customScroll?"custom-scroll": "default-scroll";t=a("option:selected",c);b.refreshSelect?a("<ul>"+n+"</ul>").prependTo(a(".select-list",g)):(n='<span class="custom-text">'+t[0].text+'</span><div class="select-list '+f+'">'+e+"<ul>"+n+"</ul></div>",a(n).prependTo(g));h=a("ul",g);r=a(".custom-text",g);i=a(".select-list",g);i.on("mousedown","li",function(){if(a(this).hasClass("disabled"))return!1;C(a(this))});a("li:eq("+t.index()+")",h).addClass("selected");g.removeClass("done");j.setWidthCS(d.width);w=parseInt(i.css("top"));b.refreshSelect|| (k=a("li:nth-child(1)",h).outerHeight());if(l<d.maxItems||0==d.maxItems)i.hide(),g.addClass("done");else if(q=!0,G=k*l,m=k*d.maxItems,h.css("height",m),i.hide(),g.addClass("done"),1==d.customScroll&&(b=k*l,x=-b+m,A=a(".select-scroll",i),A.css("height",m),s=a(".scroll-drag",i),i.addClass("maxlength"),y=b/m,H=m*(m/b),s.css("height",H),0<a(".selected",h).length&&J(a(".selected",h).index()),d.customScroll)){var u;h.bind("mousewheel",function(a,b){u=parseInt(h.css("top"))+b*k;v(u);return!1});A.click(function(b){b= 0.5<(b.pageY-a(this).offset().top)/m?-1:1;u=parseInt(h.css("top"))+k*b;v(u);return!1});s.on("mousedown",function(a){K(a,!0)});a(document).on("mouseup",function(a){K(a,!1)})}},K=function(b,c){if(c){b.preventDefault()&&b.preventDefault();var e=parseInt(s.css("top")),d=b.clientY;a(document).bind("mousemove",function(a){v((d-a.clientY-e)*y)})}else a(document).unbind("mousemove"),f=!0},v=function(a){a=0<a?0:a;a=a<x?x:a;h.css("top",a);s.css("top",-a/y)},J=function(b){if(!(0>b||b==l)){var c=b>l-d.maxItems? G-m:k*b;a(".selected",h).removeClass("selected");a("li:nth-child("+(b+1)+")",h).addClass("selected");q&&v(-c)}},C=function(a){var c=0<a.parents("select").length?a.attr("value"):a.data("value"),d=a.text();L(c,d,a.index()+1)},L=function(b,d,e){if(e>l||0==e)return!1;z=!0;a("option:eq("+a(".selected",h).index()+")",c).removeAttr("selected");a("option:eq("+(e-1)+")",c).attr("selected",!0);c.attr("value",b).change();a(".selected",h).removeClass("selected");a("li:nth-child("+e+")",h).addClass("selected"); r.text(d)},D=function(b,c,e){1==a("."+d.containerClass+".open_list").length&&a("."+d.containerClass+".open_list").children("select").data("selectik").hideCS();if(!e&&(a("."+d.containerClass+".open_list").children(".select-list").stop(!0,!0).fadeOut(d.speedAnimation).parent().toggleClass("open_list"),c))return;f=!1;j.positionCS(b);b.stop(!0,!0).fadeToggle(d.speedAnimation);b.parent().toggleClass("open_list");setTimeout(function(){f=!0},d.speedAnimation)};j.hideCS=function(){i.fadeOut(d.speedAnimation); g.removeClass("open_list");c.focus();f=!0};j.showCS=function(){f=!1;i.fadeIn(d.speedAnimation);g.addClass("open_list")};j.positionCS=function(b){elParent=b.parent();var c=q?d.maxItems*k:l*k,e=q?d.maxItems:l,e=a(window).height()-(elParent.offset().top-a(window).scrollTop())-elParent.outerHeight()<c?-e*k-elParent.outerHeight()/4:w,e=elParent.offset().top-a(window).scrollTop()<c?w:e;b.css("top",e)};j.refreshCS=function(){I({refreshSelect:!0})};j.changeCS=function(b){var b=0<b.index?b.index:a('option[value="'+ b.value+'"]',c).index()+1,d=a("option:nth-child("+b+")",c).attr("value"),e=a("option:nth-child("+b+")",c).text();L(d,e,b)};j.disableCS=function(){c.attr("disabled",!0);g.addClass("disable")};j.enableCS=function(){c.attr("disabled",!1);g.removeClass("disable")};j.requiredCS=function(){r.toggleClass("required")};j.setWidthCS=function(b){a.each([h,r],function(){var c=a(this).parent(),c=c.outerWidth()-c.width(),d=a(this).outerWidth()-a(this).width(),c=c+d;a(this).css("width",b-c)})};j.init()};a.fn.selectik= function(f){return this.each(function(){if(!(0<a("optgroup",this).length||"multiple"==a(this).attr("multiple"))&&void 0==a(this).data("selectik")){var p=new a.selectik(this,f);a(this).data("selectik",p)}})};a(window).resize(function(){f&&!(0<!a(".open_list").length)&&a(".open_list").children("select").data("selectik").positionCS(a(".select-list:visible"))});a(document).bind("click",function(){p?p=!1:f&&(f=!1,0<a(".open_list").length&&a(".open_list").children("select").data("selectik").hideCS())})})(jQuery);